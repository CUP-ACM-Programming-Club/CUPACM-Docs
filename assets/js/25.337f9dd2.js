(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{335:function(t,s,a){"use strict";a.r(s);var e=a(12),n=function(t){t.options.__data__block__={mermaid_382ee18c:"classDiagram\n    class Language\n    Language: #int DEBUG\n    Language: +run(int memory) void\n    Language: +setProcessLimit() void\n    Language: +setCompileProcessLimit() void\n    Language: +compile(std::vector<std::string>&, const char*, const char*) void\n    Language: +buildRuntime(const char* work_dir) void\n    Language: +double buildTimeLimit(double timeLimit, double bonus)\n    Language: +buildMemoryLimit(int memoryLimit, int bonus) int\n    Language: +setExtraPolicy(const char* oj_home, const char* work_dir) void\n    Language: +initCallCounter(int* call_counter) void\n    Language: +setCompileExtraConfig() void\n    Language: +setCompileMount(const char* work_dir) void\n    Language: +getCompileResult(int status) int\n    Language: +fixACStatus(int acFlag) int\n    Language: +getMemory(rusage ruse, pid_t pid) int\n    Language: +buildChrootSandbox(const char* work_dir) void\n    Language: +runMemoryLimit(rlimit& LIM) void\n    Language: +fixACFlag(int& ACflg) void\n    Language: +enableSim() bool\n    Language: +fixFlagWithVMIssue(char *work_dir, int &ACflg, int &topmemory,int mem_lmt) void\n    Language: +std::string getFileSuffix()\n    Language: +gotErrorWhileRunning(bool error) bool\n    Language: +isValidExitCode(int exitcode) bool\n    Language: #setCPULimit() void\n    Language: #setFSizeLimit() void\n    Language: #setASLimit() void\n    Language: #setAlarm() void",mermaid_382ee1a2:"classDiagram\nclass Language\nclass C11\nclass C99\nclass Cpp11\nckass Clang\nLanguage<|--C11\nLanguage<|--Java\nLanguage<|--Bash\nLanguage<|--Csharp\nLanguage<|--Pascal\nLanguage<|--Python2\nLanguage<|--Python3\nC11<|--C99\nC11<|--Cpp11\nC11<|--Clang\nJava<|--Java 8\nJava<|--Java 7",mermaid_64a55120:"graph LR;\n    路由中间件--SQL查询--\x3eMySQL缓存层;\n    MySQL缓存层--SQL查询--\x3eMySQL数据库;\n    MySQL数据库-.结果.->MySQL缓存层;\n    MySQL缓存层--缓存查询--\x3e缓存;\n    MySQL缓存层--缓存更新--\x3e缓存;\n    缓存-.返回缓存 or null.->MySQL缓存层;\n    MySQL缓存层-.返回结果.->路由中间件;",mermaid_64a550e2:"graph LR;\n    路由中间件--SQL查询--\x3eMySQL缓存层;\n    MySQL缓存层--SQL查询--\x3eMySQL数据库;\nMySQL缓存层--加锁/解锁--\x3eMySQL缓存层\n    MySQL数据库-.结果.->MySQL缓存层;\n    MySQL缓存层--缓存查询--\x3e缓存;\n    MySQL缓存层--缓存更新--\x3e缓存;\n    缓存-.返回缓存 or null.->MySQL缓存层;\n    MySQL缓存层-.返回结果.->路由中间件;",mermaid_64a550b0:"graph LR;\n    路由中间件--SQL查询--\x3eMySQL缓存层;\n    MySQL缓存层--SQL查询--\x3eMySQL数据库;\nMySQL缓存层--加锁/解锁--\x3e锁管理器;\n    MySQL数据库-.结果.->MySQL缓存层;\n    MySQL缓存层--缓存查询--\x3e缓存;\n    MySQL缓存层--缓存更新--\x3e缓存;\n    缓存-.返回缓存 or null.->MySQL缓存层;\n    MySQL缓存层-.返回结果.->路由中间件;\n</mermaid>>\n\n通过以上几步优化，我们成功将原本并发量为1~~也就是完全没有并发的杂鱼~~提升为500rps上下。\n\n但是500rps并不能让我们停止对性能提升的追求。通过使用`top`工具观察压测过程中的资源使用情况，我们发现对于单进程，`node`已经跑满单核CPU的所有计算资源。我们知道，`Node.js`使用单线程维护事件队列保证异步高并发的运行环境。而我们显然需要发挥一台计算机多核的威力，不能仅实现一核有难，多核围观这一情况。\n\n### Cluster\nNode.js在官方库中提供了`Cluster`这一模块，使得Node应用能够以集群的形式运行在服务器上。\n\n我们可以通过启动一个`Master`进程，fork与CPU数量相当的`Worker`进程，由`Master`进程获得TCP连接，使用RoundRobin算法平均分配给各个进程，实现负载均衡。\n<mermaid>\ngraph TD;\nTCP--\x3eA;\nA[Master进程]--\x3eB[Worker 1];\nA[Master进程]--\x3eC[Worker 2];\nA[Master进程]--\x3eD[Worker 3];\nA[Master进程]--\x3eE[Worker 4];\nA[Master进程]--\x3eF[Worker 5];\nA[Master进程]--\x3eG[Worker 6];\nA[Master进程]--\x3eH[Worker 7];\nA[Master进程]--\x3eI[Worker 8];",mermaid_64a54adc:"graph TD;\nA[CUP Online Judge]--\x3eB[CUP Online Judge Express];\nA--\x3eC[CUP Online Judge WebSocket]\nB--\x3eHTTP\nHTTP-.->B\nC--\x3eWebSocket\nWebSocket-.->C\nHTTP--\x3eD[Client]\nWebSocket--\x3eD",mermaid_64a54ad4:"graph TD;\nU[Worker]--通知更新--\x3eA[Master]\nA--广播--\x3eB[Worker 2]\nA--广播--\x3eC[Worker 3]\nA--广播--\x3eD[Worker 4]\nA--广播--\x3eE[Worker 5]",mermaid_64a54a66:"graph LR;\nA[New Worker]--bootstrap--\x3eB[Worker Set]\nB--Destroy--\x3eC[Dead Worker]",mermaid_300893f6:"graph TD\nA[Worker] --Notify--\x3e B[Master]\nB --Fork--\x3e C[new Worker]\nC --\x3e D{isAlive?}\nD --N--\x3eE[End]\nD --Y--\x3e F[Fork new workers]\nF --\x3e G[Update worker queue]\nG --\x3e E"}},r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[a("strong",[t._v("CUP Online Judge")]),t._v("是一个以Vue.js作为前端框架，ExpressJS 作为后端框架开发的在线评测系统。")]),t._v(" "),a("p",[a("em",[t._v("注: CUP Virtual Judge属于较为独立的、技术栈未成熟的另外一个程序，因此在本程序中不会涉及到与Virtual Judge系统相关的接口开发问题。")])]),t._v(" "),a("p",[a("strong",[t._v("CUP Virtual Judge由于国内各大OJ调整对海外IP地址访问的策略，现在暂时停止提交功能，保留题目内容供查询。")])]),t._v(" "),a("h2",{attrs:{id:"判题机重构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#判题机重构"}},[t._v("#")]),t._v(" 判题机重构")]),t._v(" "),a("p",[t._v("本OJ判题机重构自HUSTOJ。\n由于需求的变更，当前的判题机和原本的HUSTOJ有了很大的差别。CUPOJ Judger无法向下兼容HUSTOJ。\n"),a("s",[t._v("也许HUSTOJ可以向上兼容CUPOJ")])]),t._v(" "),a("p",[t._v("本判题机和原判题机的区别是对判题语言模块进行了抽象，并将除了判题机核心模块做成动态模块，可自行动态引用。\n同时，HUSTOJ判题机使用libmysql-devel等mysql提供的C库实现拉取数据与更新，而该功能目前已经在CUPOJ Judger中移除。")]),t._v(" "),a("p",[t._v("数据的更新和获得通过文件及Socket获取。判题机本身可独立于数据库运行，这是CUPOJ Judger和HUSTOJ判题机的另一大区别。")]),t._v(" "),a("p",[t._v("目前判题机的mysql接口已经被单独封装成抽象基类，通过引用动态库调用具体实现。")]),t._v(" "),a("p",[t._v("CUPOJ Judger的所有动态库均定位在"),a("code",[t._v("/usr/lib/cupjudge")]),t._v("目录下。")]),t._v(" "),a("p",[t._v("事实证明，通过使用策略模式重构判题机更有利于解耦判题机中的功能，实现开闭原则。")]),t._v(" "),a("p",[t._v("下面将具体讲述如何针对判题机开发新语言模组")]),t._v(" "),a("h3",{attrs:{id:"为judger开发新语言模组"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为judger开发新语言模组"}},[t._v("#")]),t._v(" 为Judger开发新语言模组")]),t._v(" "),a("p",[t._v("CUPOJ Judger语言模组均继承"),a("code",[t._v("Language")]),t._v("基类，该基类为抽象类，成员为")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_382ee18c",graph:t.$dataBlock.mermaid_382ee18c}}),a("Mermaid",{attrs:{id:"mermaid_382ee1a2",graph:t.$dataBlock.mermaid_382ee1a2}}),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifndef")]),t._v(" JUDGE_CLIENT_LANGUAGE_H")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" JUDGE_CLIENT_LANGUAGE_H")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(' extlang extern "C" Language*')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(' deslang extern "C" void')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" HOJ_MAX_LIMIT (-1)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" call_array_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("512")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<vector>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<string>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<sys/resource.h>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Language")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" memory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setProcessLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompileProcessLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildRuntime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("double")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildTimeLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("double")]),t._v(" timeLimit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("double")]),t._v(" bonus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildMemoryLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" memoryLimit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" bonus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setExtraPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" oj_home"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initCallCounter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" call_counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompileExtraConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompileMount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCompileResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fixACStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" acFlag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMemory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rusage ruse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pid_t pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildChrootSandbox")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runMemoryLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rlimit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" LIM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fixACFlag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" ACflg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("enableSim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fixFlagWithVMIssue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ACflg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("topmemory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" mem_lmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("string "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFileSuffix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("gotErrorWhileRunning")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isValidExitCode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" exitcode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Language")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCPULimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setFSizeLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setASLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAlarm")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" Language"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createLanguageInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("destroyLanguageInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Language"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//JUDGE_CLIENT_LANGUAGE_H")]),t._v("\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br")])]),a("p",[t._v("下面将具体讲述该基类各个部分的含义与具体功能。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(' extlang extern "C" Language*')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(' deslang extern "C" void')]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("code",[t._v("extlang")]),t._v("和"),a("code",[t._v("deslang")]),t._v("是一组宏定义。当判题机需要引入一个语言模组，会调用"),a("code",[t._v("getLanguageModel")]),t._v("方法:")]),t._v(" "),a("h4",{attrs:{id:"getlanguagemodel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#getlanguagemodel"}},[t._v("#")]),t._v(" getLanguageModel")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("Language"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLanguageModel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" language"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    string languageName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" languageNameReader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("to_string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("language"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" languageHandler "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlopen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/lib/cupjudge/lib"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" languageName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('".so"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" RTLD_LAZY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("languageHandler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        cerr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Cannot load library: "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" endl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    createLanguageInstance"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" createInstance "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("createLanguageInstance"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlsym")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("languageHandler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"createInstance"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" languageName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" dlsym_error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dlerror")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dlsym_error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        cerr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Cannot load symbol create: "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" dlsym_error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" endl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('//    destroyLanguageInstance* destroyInstance = (destroyLanguageInstance*) dlsym(languageHandler, (string("destroyInstance") + languageName).c_str());')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    dlsym_error = dlerror();")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    if (dlsym_error) {")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('//        cerr << "Cannot load symbol create: " << dlsym_error << endl;')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        exit(1);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    }")]),t._v("\n\n    Language"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" languageInstance "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" languageInstance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br")])]),a("p",[t._v("如以上代码，不难发现该方法通过languageNameReader根据"),a("code",[t._v("lang")]),t._v("变量读取了一个字符串。")]),t._v(" "),a("p",[t._v("其中,"),a("code",[t._v("languageNameReader")]),t._v("是一个JSON类的封装，在这里读取了"),a("code",[t._v("/home/judge/etc/language.json")]),t._v("文件。")]),t._v(" "),a("p",[t._v("该文件中设置了"),a("code",[t._v("lang")]),t._v("变量与对应动态链接库文件名的映射。")]),t._v(" "),a("p",[t._v("因此在这里，我们从"),a("code",[t._v("languageNameReader")]),t._v("拿到了动态链接库名，并使用"),a("code",[t._v("dlfcn.h")]),t._v("头文件动态引入"),a("code",[t._v("Language")]),t._v("基类的语言实现实例指针，并返回。")]),t._v(" "),a("p",[t._v("在代码中，我们发现"),a("code",[t._v("createInstance")]),t._v("方法是取自"),a("code",[t._v("lib${languageName}.so")]),t._v("文件中使用"),a("code",[t._v('extern "C" createInstance${languageName}()')]),t._v("暴露的方法。")]),t._v(" "),a("p",[t._v("而在上面，我们提到"),a("code",[t._v("extlang")]),t._v(","),a("code",[t._v("deslang")]),t._v("这一组宏定义。这组宏定义用于定义暴露给Judger调用的一组构造和析构函数。")]),t._v(" "),a("p",[t._v("暴露的两个方法名称需要遵守以下命名方式:\n"),a("code",[t._v("createInstance${languageName}()")]),t._v(" "),a("code",[t._v("destroyInstance${languageName}(Language*)")]),t._v(" "),a("code",[t._v("languageName")]),t._v("与"),a("code",[t._v("language.json")]),t._v("中的语言名对应。")]),t._v(" "),a("p",[t._v("如在"),a("code",[t._v("language.json")]),t._v("中定义了"),a("code",[t._v("C11")]),t._v("语言字段为"),a("code",[t._v('"0": "c11"')]),t._v("\n那么这两个方法则命名为:\n"),a("code",[t._v("createInstancec11()")]),t._v(" "),a("code",[t._v("destroyInstancec11(Language*)")])]),t._v(" "),a("p",[t._v("而在"),a("code",[t._v("getLanguageModel")]),t._v("中则使用"),a("code",[t._v("createInstancec11")]),t._v("拿到构造函数的返回指针。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" HOJ_MAX_LIMIT (-1)")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该宏定义定义了允许的syscall的值。\n可通过在"),a("code",[t._v("syscall")]),t._v("目录下设定syscall32.h与syscall64.h头文件，定义判题过程中允许的syscall。\n判题机会通过ptrace跟踪用户程序运行中使用的syscall，并在用户程序调用syscall之前进行检查。\n未经允许的syscall调用将会被判题机以"),a("code",[t._v("RUNTIME ERROR")]),t._v("结束进程。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" memory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法定义了判题机启动用户已编译的程序文件所调用的方法。\n以"),a("code",[t._v("C11")]),t._v("为例，该方法的实现为")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" C11"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" memory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("execl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./Main"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./Main"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nullptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("需要注意的是，该方法强制重写，所有语言模组必须自行重写该纯虚函数。\n调用则需要以"),a("code",[t._v("execl")]),t._v("方法启动。在判题机中，该进程将会作为Judger的子进程"),a("code",[t._v("fork")]),t._v("出来，并重定向了输入输出文件流及错误流。\n"),a("code",[t._v("execl")]),t._v("的使用方法请参考Linux C中关于exec系列函数的手册。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setProcessLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法设定用户程序运行时的进程数限制。\n考虑到不同语言的代码运行时会运行的进程数量不同，请根据判题实际可能使用的进程数进行限制。\n"),a("code",[t._v("Language")]),t._v("默认提供一个"),a("code",[t._v("setrlimit")]),t._v("NPROC为1的实现。若该方法不被重写，则限制用户进程仅允许一个进程。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompileProcessLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法限制判题机在编译用户代码过程中的系统资源限制。\n考虑到不同语言的编译过程对资源要求的不同，该方法建议重写。\n方法默认提供一个基本的资源限制，适用于C及C++语言环境的要求。\n该方法默认调用"),a("code",[t._v("protected")]),t._v("中提供的"),a("code",[t._v("set*")]),t._v("函数，用于设置编译器资源使用限制，以防止编译炸弹的安全隐患。")]),t._v(" "),a("p",[t._v("因此重写该方法时，请注意一并重写"),a("code",[t._v("protected")]),t._v("下的所有"),a("code",[t._v("set")]),t._v("方法。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法提供了一个通用语言具体的compile流程。"),a("code",[t._v("Language")]),t._v("基类提供了一个通配编译流程，可以不用重写该方法。")]),t._v(" "),a("p",[t._v("不过仍然需要注意的是，编译的shell参数表保存在"),a("code",[t._v("/home/judge/etc/compile.json")]),t._v("文件中，以\n"),a("code",[t._v("[语言id]:[编译参数数组]")]),t._v("的json文件保存，因此需要手动为该文件添加编译参数，使Judger能够将编译参数数组读入并传入该"),a("code",[t._v("compile")]),t._v("方法。")]),t._v(" "),a("p",[t._v("目前所有语言中仅"),a("code",[t._v("Java")]),t._v("语言需要重写该方法，因为其编译需要"),a("code",[t._v("java_xms")]),t._v("和"),a("code",[t._v("java_xmx")]),t._v("两个参数。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildRuntime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法在创建沙箱时调用。\n该方法将该语言需要的运行时复制到"),a("code",[t._v("/home/judge/run${runid}/")]),t._v("目录下。")]),t._v(" "),a("p",[t._v("运行时，判题机在根据情况将环境"),a("code",[t._v("chroot")]),t._v("到沙箱中，因此要将运行时依赖的库文件拷贝到这里。")]),t._v(" "),a("p",[a("code",[t._v("Language")]),t._v("基类提供了一套"),a("code",[t._v("shell")]),t._v("的动态库依赖的拷贝方案，而对于C语言等可编译静态库、独立运行的二进制程序，该过程可以忽略。\n因此需要强制重写该方法并留空运行内容。")]),t._v(" "),a("p",[t._v("而对于其他的需要运行时的语言，则不仅要调用基类的方法，也要自行编写拷贝语言运行时动态库的过程。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("double")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildTimeLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("double")]),t._v(" timeLimit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("double")]),t._v(" bonus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildMemoryLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" memoryLimit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" bonus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("该方法用于设置用户程序运行时限。传入两个参数分别是")]),t._v(" "),a("ul",[a("li",[t._v("timeLimit: 题目设置时间限制")]),t._v(" "),a("li",[t._v("memoryLimit: 题目设置内存限制")]),t._v(" "),a("li",[t._v("bonus: 预设的语言延长时限")])]),t._v(" "),a("p",[t._v("返回值是判题机将采纳的时间限制。")]),t._v(" "),a("p",[t._v("由于约定俗成的某些规矩，我们可以对某些运行比较慢的运行时适当给出宽限时间空间，因此可通过重写该方法，返回一个合适的时间限制。")]),t._v(" "),a("p",[a("strong",[t._v("但是请不要在这里恶作剧，这样对自己没有好处，对做题者也没有好处。")])]),t._v(" "),a("p",[t._v("该方法默认提供一个直接返回"),a("code",[t._v("timeLimit")]),t._v("("),a("code",[t._v("memoryLimit")]),t._v(")的函数。建议C/C++不要重写该方法，其他语言可适当重写该方法。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setExtraPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" oj_home"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("这个方法用于设置语言附加的一些特性或限制。目前仅限用于Java语言设置"),a("code",[t._v("policy")]),t._v("。\n若有其他需要额外添加的特性，可以考虑加入。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initCallCounter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" call_counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("初始化syscall追踪数组。")]),t._v(" "),a("p",[t._v("该方法将会传入一个数组，用于"),a("code",[t._v("ptrace")]),t._v("记录调用过的syscall。\n由于不同语言运行过程中可能调用不同的syscall，因此请使用record模式先对一个默认程序运行，根据输出的内容设置syscall。")]),t._v(" "),a("p",[t._v("关于这一个部分的设置，请参考"),a("code",[t._v("C11")]),t._v("对于syscall的设置方法，这里先不详细展开。")]),t._v(" "),a("p",[t._v("该方法强制重写。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildSeccompSandbox")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("设置Sccomp沙箱设置。\n该方法将根据Syscall设置\b创建一个基于seccomp的沙箱。该功能和ptrace实现的沙箱类似，据说会有一定的性能提升，可参考其他已实现的库的实现方式。")]),t._v(" "),a("p",[t._v("该方法强烈建议重写。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompileExtraConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法在"),a("code",[t._v("compile")]),t._v("运行前调用。用于为编译流程添加额外的设置。")]),t._v(" "),a("p",[t._v("在实际使用中有Pascal和Freebasic需要重定向输入流，其他语言可以不重写(因为一般用不上)。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompileMount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法将系统的一些文件夹绑定到沙箱中。")]),t._v(" "),a("p",[t._v("由于编译过程中某些语言使用到了系统文件夹，为了保证这些语言能够成功编译，"),a("code",[t._v("Language")]),t._v("基类默认提供了几个基础文件夹的"),a("code",[t._v("mount")]),t._v("过程。")]),t._v(" "),a("p",[t._v("对于不需要这些过程的语言，可以重写该方法并留空。")]),t._v(" "),a("p",[t._v("若有其他mount设定，也可以重写该方法并自行定义该过程。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCompileResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法定义了获得编译结果的函数。")]),t._v(" "),a("p",[t._v("该方法传入"),a("code",[t._v("status")]),t._v("，该值为运行"),a("code",[t._v("compile")]),t._v("cli程序获得的返回值。一般来说，该值应该为0，代表编译程序正常退出。")]),t._v(" "),a("p",[t._v("考虑到某些语言即使返回0，也并不代表编译通过。因此需要重写该判断流程，通过return返回非0的编译错误结果。")]),t._v(" "),a("p",[t._v("默认返回"),a("code",[t._v("status")]),t._v("。若非特别需要，可不重写。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fixACStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" acFlag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于在某些特殊情况修复AC结果")]),t._v(" "),a("p",[t._v("该方法传入AC状态。")]),t._v(" "),a("p",[t._v("该方法在运行结束后执行。")]),t._v(" "),a("p",[t._v("考虑到像CPython环境(或其他语言)可能将运行错误等其他错误通过"),a("code",[t._v("stdout")]),t._v("或者"),a("code",[t._v("stderr")]),t._v("输出。")]),t._v(" "),a("p",[t._v("因此可以通过该函数插桩，修改判题结果。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMemory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rusage ruse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pid_t pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于返回程序运行内存。")]),t._v(" "),a("p",[t._v("传入"),a("code",[t._v("wait4")]),t._v("返回的ruse和用户程序pid。")]),t._v(" "),a("p",[t._v("根据不同的运行时可能有不同的内存使用检测方法。")]),t._v(" "),a("p",[t._v("该方法有缺省返回。若非特别需要，可以不用重写该方法")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildChrootSandbox")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于构建chroot环境。")]),t._v(" "),a("p",[t._v("一般不需要重写该方法。")]),t._v(" "),a("p",[t._v("然而，针对类似Java语言在chroot以后无法运行的情况，因此本方法需要重写为一个空函数。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("string "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFileSuffix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于返回该语言的通用文件后缀。")]),t._v(" "),a("p",[t._v("用户代码将会作为文件写入磁盘，为了编译器正确识别文件，需要强制重写该方法。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fixACFlag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" ACflg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法与"),a("code",[t._v("fixACStatus")]),t._v("相同。")]),t._v(" "),a("p",[t._v("唯一的区别是该方法在"),a("code",[t._v("judge_solution")]),t._v("后运行，"),a("code",[t._v("fixACStatus")]),t._v("在"),a("code",[t._v("judge_solution")]),t._v("过程中运行。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("enableSim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法返回判题机是否启动判重功能的flag。")]),t._v(" "),a("p",[t._v("默认返回"),a("code",[t._v("false")])]),t._v(" "),a("p",[t._v("由于判题机支持的判重程序支持的语言有限，请查阅"),a("code",[t._v("SIM similarity")]),t._v("的支持语言后决定该方法是否重写。")]),t._v(" "),a("p",[t._v("建议C/C++/Java语言强制开启。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fixFlagWithVMIssue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("work_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ACflg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("topmemory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" mem_lmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于修复由于VM问题导致的错误AC结果。")]),t._v(" "),a("p",[t._v("请注意，该方法和VM运行机制强相关，因此请确认该方法在判题机的运行顺序的关系并查阅判题机的Java实现对于该方法的使用后，再决定该方法如何重写。")]),t._v(" "),a("p",[t._v("一般不需要重写该方法。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("gotErrorWhileRunning")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于判断用户程序运行过程检测到"),a("code",[t._v("error.out")]),t._v("文件有输出时，是否应该继续。")]),t._v(" "),a("p",[t._v("该方法传入的"),a("code",[t._v("error")]),t._v("代表"),a("code",[t._v("error.out")]),t._v("，即"),a("code",[t._v("stderr")]),t._v("是否有输出。")]),t._v(" "),a("p",[t._v("考虑到如C/C++语言，若用户程序输出错误，则说明用户程序已经无法继续运行，应该停止。")]),t._v(" "),a("p",[t._v("而其他某些语言中，错误输出可能出现在内核或者VM部分，这时也许可以继续运行。")]),t._v(" "),a("p",[t._v("因此请仔细考虑有错误输出时是否应该继续。")]),t._v(" "),a("p",[t._v("一般情况请重写该方法。")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isValidExitCode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" exitcode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("该方法用于判断程序的返回值是否为合法返回值。")]),t._v(" "),a("p",[t._v("传入"),a("code",[t._v("exitcode")]),t._v("是用户进程结束时返回的code。")]),t._v(" "),a("p",[t._v("对于一般情况，返回"),a("code",[t._v("0")]),t._v("代表程序正常退出，而其他的数字代表不正常的结果。")]),t._v(" "),a("p",[t._v("而对于某些情况，VM可能会fork多个进程，或者程序自动使用多进程的模式执行，而退出的代码不为"),a("code",[t._v("0")]),t._v("。")]),t._v(" "),a("p",[t._v("因此请根据该语言的退出码决定如何重写该方法。")]),t._v(" "),a("p",[t._v("该方法提供缺省的判断条件。")]),t._v(" "),a("p",[t._v("一般不需要重写。")]),t._v(" "),a("h2",{attrs:{id:"分布式负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分布式负载均衡"}},[t._v("#")]),t._v(" 分布式负载均衡")]),t._v(" "),a("p",[t._v("由于CRUD API已充分和判题机、WebSocket服务解耦合，可通过设置反向代理实现负载均衡，进一步提升集群化后Express服务的性能。")]),t._v(" "),a("h2",{attrs:{id:"微服务尝试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务尝试"}},[t._v("#")]),t._v(" 微服务尝试")]),t._v(" "),a("p",[t._v("众所周知，Node.js针对计算密集型应用表现的性能远不如其他主流语言。为了解决一部分运算密集的任务，或保证应用高可用，微服务是一个值得考虑的方向。")]),t._v(" "),a("p",[t._v("目前基于Dubbo RPC的方案正在开发中。已经完成了初始阶段的跨语言调用与注册中心的配置。")]),t._v(" "),a("p",[t._v("有关Java微服务的内容，可查看"),a("a",{attrs:{href:"https://github.com/ryanlee2014/CUP-Online-Judge-Java-Backend",target:"_blank",rel:"noopener noreferrer"}},[t._v("CUP-Online-Judge-Java-Backend"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"dockerize-尝试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dockerize-尝试"}},[t._v("#")]),t._v(" Dockerize 尝试")]),t._v(" "),a("p",[t._v("在2018年1月的时候曾经基于Docker+Node.js开发出第一代Docker Judger,这一版Docker Judger成功适配了Kotlin,但由于设计方案的缺陷，判题的速度远不如用原版非Docker的判题机。")]),t._v(" "),a("p",[t._v("经研究发现，Dockerize的正确方法并不是直接将用户的代码丢到沙箱中编译运行，而是应该作为一个docker化的服务在后台运行。")]),t._v(" "),a("p",[t._v("为了使容器中的判题机能够被外界感知，故设计CUP-Online-Judge-Judger-Daemon-Server与CUP-Online-Judge-Judger进行整合，通过编写Dockerfile将其封装成一个容器。")]),t._v(" "),a("p",[t._v("通过docker-compose配置好环境变量后启动。通过暴露端口5110作为Websocket与后端协同的同时，后端将原本的判题模块改为通信模块，将判题部分和WebSocket服务解耦合，提高了原本应用的扩展性。")]),t._v(" "),a("p",[t._v("通过docker-compose设置volumes,将判题机的配置文件和数据文件夹映射到判题机容器中，便于独立设置判题机参数。")]),t._v(" "),a("p",[t._v("docker-compose文件可以在"),a("a",{attrs:{href:"https://github.com/ryanlee2014/CUP-Online-Judge-NG-Docker-Judger",target:"_blank",rel:"noopener noreferrer"}},[t._v("CUP-Online-Judge-NG-Docker-Judger"),a("OutboundLink")],1),t._v("找到")]),t._v(" "),a("h2",{attrs:{id:"github-actions-持续集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#github-actions-持续集成"}},[t._v("#")]),t._v(" Github Actions 持续集成")]),t._v(" "),a("p",[t._v("CUP-Online-Judge-NG-FrontEnd使用了"),a("code",[t._v("Github Actions")]),t._v("进行全自动持续集成")]),t._v(" "),a("p",[t._v("根据设置，持续集成环境配置支持")]),t._v(" "),a("ul",[a("li",[t._v("本地构建->持续集成发布")]),t._v(" "),a("li",[t._v("远程构建->发布")])]),t._v(" "),a("h3",{attrs:{id:"本地构建-持续集成发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#本地构建-持续集成发布"}},[t._v("#")]),t._v(" 本地构建->持续集成发布")]),t._v(" "),a("ol",{attrs:{start:"0"}},[a("li",[t._v("将根目录下"),a("code",[t._v("NEED_BUILD")]),t._v("文件内容改为"),a("code",[t._v("false")])]),t._v(" "),a("li",[t._v("在本地开发环境运行"),a("code",[t._v("npm run modern")])]),t._v(" "),a("li",[t._v("运行"),a("code",[t._v("git add dist")]),t._v("将"),a("code",[t._v("dist")]),t._v("目录下所有文件加入本次变更")]),t._v(" "),a("li",[t._v("push到Github环境，启动自动发布。")])]),t._v(" "),a("h3",{attrs:{id:"远程构建-发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#远程构建-发布"}},[t._v("#")]),t._v(" 远程构建->发布")]),t._v(" "),a("ol",{attrs:{start:"0"}},[a("li",[t._v("将根目录下"),a("code",[t._v("NEED_BUILD")]),t._v("文件内容改为"),a("code",[t._v("true")])]),t._v(" "),a("li",[t._v("push到Github环境，启动自动发布。")])]),t._v(" "),a("h3",{attrs:{id:"发布目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#发布目标"}},[t._v("#")]),t._v(" 发布目标")]),t._v(" "),a("p",[t._v("持续集成工作流会把"),a("code",[t._v("dist")]),t._v("文件夹内容发布到"),a("code",[t._v("CUP-Online-Judge-CDN")]),t._v("仓库中，并将根据打包过程中生成的版本发布"),a("code",[t._v("releases")]),t._v("供jsDelivr缓存")]),t._v(" "),a("h2",{attrs:{id:"cdn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cdn"}},[t._v("#")]),t._v(" CDN")]),t._v(" "),a("p",[t._v("考虑到本系统所有前端的文件经过打包后大小高达50MB,考虑在非必要时候使用CDN分担服务器的网络压力")]),t._v(" "),a("h3",{attrs:{id:"jsdelivr-cdn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jsdelivr-cdn"}},[t._v("#")]),t._v(" jsDelivr CDN")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://oj.cupacm.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://oj.cupacm.com"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.cupacm.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cupacm.com"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("以上节点使用了jsDelivr作为CDN服务提供方，通过持续集成自动部署发布版本到CUP-Online-Judge-CDN仓库，即可简单通过控制index.html更改需要部署的前端版本")]),t._v(" "),a("h2",{attrs:{id:"云化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#云化"}},[t._v("#")]),t._v(" 云化")]),t._v(" "),a("h3",{attrs:{id:"datasource"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#datasource"}},[t._v("#")]),t._v(" Datasource")]),t._v(" "),a("ul",[a("li",[t._v("MySQL 使用阿里云RDS MySQL服务器")])]),t._v(" "),a("h3",{attrs:{id:"middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#middleware"}},[t._v("#")]),t._v(" Middleware")]),t._v(" "),a("ul",[a("li",[t._v("判题机注册节点 "),a("strong",[t._v("待开发")])])]),t._v(" "),a("h3",{attrs:{id:"core"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#core"}},[t._v("#")]),t._v(" Core")]),t._v(" "),a("ul",[a("li",[t._v("前端 已完成")]),t._v(" "),a("li",[t._v("后端 已完成")]),t._v(" "),a("li",[t._v("判题机 待开发")])]),t._v(" "),a("h2",{attrs:{id:"线上已知问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线上已知问题"}},[t._v("#")]),t._v(" 线上已知问题")]),t._v(" "),a("p",[t._v("迁移至"),a("a",{attrs:{href:"/discuss/thread/17"}},[t._v("CUP Online Judge系统问题整理复盘")]),t._v(" "),a("s",[t._v("* WebSocket进程有CPU hang100%的现象")]),t._v(" "),a("s",[t._v("解决方案:排查中")])]),t._v(" "),a("p",[a("s",[t._v("* 提交事件响应抖动造成冗余提交")]),t._v(" "),a("s",[t._v("解决方案: 前端去颤加锁，后端加计时器")])]),t._v(" "),a("p",[a("s",[t._v("* \b发布有较大不确定性，有不可预估的风险")]),t._v(" "),a("s",[t._v("解决方案: 新增部署dev环境->ppe环境->prod环境发布链，新发布统一走SOP变更。")])]),t._v(" "),a("h2",{attrs:{id:"typescript改造"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#typescript改造"}},[t._v("#")]),t._v(" TypeScript改造")]),t._v(" "),a("blockquote",[a("p",[t._v("动态一时爽，重构火葬场")])]),t._v(" "),a("p",[t._v("为了杜绝以上情况的出现，现计划通过改造当前后端，使用TypeScript语言重构。")]),t._v(" "),a("p",[a("strong",[t._v("注: 使用TypeScript请务必抽象化规范化各种DO,减少不必要的"),a("code",[t._v("any")]),t._v("声明")])]),t._v(" "),a("p",[t._v("如果你也对重构计划感兴趣，欢迎访问")]),t._v(" "),a("ul",[a("li",[t._v("(后端)"),a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP-Online-Judge-Express/tree/typescript",target:"_blank",rel:"noopener noreferrer"}},[t._v("CUP-Online-Judge-Express:typescript"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("(前端)"),a("a",{attrs:{href:"https://github.com/ryanlee2014/CUP-Online-Judge-NG-FrontEnd",target:"_blank",rel:"noopener noreferrer"}},[t._v("CUP-Online-Judge-NG-FrontEnd"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("为我们贡献代码")]),t._v(" "),a("h2",{attrs:{id:"集群化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集群化"}},[t._v("#")]),t._v(" 集群化")]),t._v(" "),a("p",[t._v("目前后端功能逐渐丰富，接口的数量也逐渐增加，带来的性能开销也越来越大。在高并发及高任务提交的环境下，数据库查询队列负载过重，同时CPU占用率高导致判题效率严重下降，造成较为严重的后果。")]),t._v(" "),a("p",[t._v("在当天晚上通过使用Apache Bench对后端接口进行压测过程发现，服务器多个接口均存在不能耐受突发高并发请求的情况。包括但不限于：")]),t._v(" "),a("ul",[a("li",[t._v("问题历史页面接口: "),a("code",[t._v("problemstatus")]),t._v(" (响应时间: 4s)")]),t._v(" "),a("li",[t._v("问题集接口： "),a("code",[t._v("problemset")]),t._v(" (响应时间:1s)")]),t._v(" "),a("li",[t._v("竞赛列表接口： "),a("code",[t._v("contest")]),t._v(" (响应时间: 800ms)")]),t._v(" "),a("li",[t._v("...")])]),t._v(" "),a("p",[t._v("原缓存模型为：")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a55120",graph:t.$dataBlock.mermaid_64a55120}}),a("p",[t._v("以上接口在面临高并发请求任务时，由于服务器本身缓存部分为MySQL任务结果，并没有对接口本身做缓存优化，因此存在以下缓存穿透的可能。")]),t._v(" "),a("p",[t._v("在高并发环境下，对于SQL查询语句存在重复的情况，而部分慢查询不能及时将数据存到缓存层中，造成缓存穿透，所有请求直接打到数据库，造成后端服务器掉底。")]),t._v(" "),a("p",[t._v("针对这种情况，可以考虑使用加锁进行优化。对于每个查询，先获得锁，然后进行查询缓存任务，完成后释放锁，保证后续任务能够直接命中缓存。")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a550e2",graph:t.$dataBlock.mermaid_64a550e2}}),a("p",[t._v("以上模型能够解决慢查询击穿数据库的问题。但是如果并发量较大，初始未加缓存的情况下仅能有一个查询在同时进行，性能还没有达到最优。这时候我们可以考虑维护锁管理器，对于每个查询按照指定的规则生成锁的键值，对于每类查询，保证只会命中特定的锁，而不影响其他无关查询的性能。")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a550b0",graph:t.$dataBlock.mermaid_64a550b0}}),a("p",[t._v("但是为什么我没有一开始就用这种模型开发呢？\n因为在我们系统中"),a("strong",[t._v("存在单例模式的组件，组件对变更事件敏感")]),t._v("。\n以下组件是要求严格单例模式且需要即时响应请求的:")]),t._v(" "),a("ol",[a("li",[t._v("判题模块")]),t._v(" "),a("li",[t._v("ConfigManager")]),t._v(" "),a("li",[t._v("在线用户管理")]),t._v(" "),a("li",[t._v("WebSocket通信模块")])]),t._v(" "),a("p",[t._v("其中(1)(3)(4)模块的抽象保证耦合，(2)模块要求即时同步更新。")]),t._v(" "),a("p",[t._v("对于前面这种情况，我采用应用切分的方式实现功能的解耦合，将(1)(3)(4)作为一个新服务切分出来，在其他服务掉底的情况仍能保持判题功能。")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a54adc",graph:t.$dataBlock.mermaid_64a54adc}}),a("p",[t._v("后面这种情况，使用进程间通信保证一致性。")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a54ad4",graph:t.$dataBlock.mermaid_64a54ad4}}),a("p",[t._v("然后经过一番优化以后，上述几个瓶颈接口达到了惊人的2300rps,更不用说剩下一些不涉及数据存取的部分，性能提升相当显著。")]),t._v(" "),a("h3",{attrs:{id:"热更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热更新"}},[t._v("#")]),t._v(" 热更新")]),t._v(" "),a("p",[t._v("考虑推线上发布的时候会短暂影响用户的使用体验，而在改造集群以后可以通过负载均衡分配任务给不同的Worker进程。因此可以通过现有的模型改造热更新方案。")]),t._v(" "),a("p",[t._v("通过IPC通信通知Master进程重启，Master进程将Worker进程时间Promise化，实现平滑进程过渡，保证用户在无感知情况下实现更新。")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a54a66",graph:t.$dataBlock.mermaid_64a54a66}}),a("h2",{attrs:{id:"为什么选用node-js作为后端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么选用node-js作为后端"}},[t._v("#")]),t._v(" 为什么选用Node.js作为后端")]),t._v(" "),a("p",[t._v("Node.js有以下优点:")]),t._v(" "),a("ul",[a("li",[t._v("单线程\n"),a("ul",[a("li",[t._v("协程")])])]),t._v(" "),a("li",[t._v("高并发\n"),a("ul",[a("li",[t._v("I/O密集")])])]),t._v(" "),a("li",[t._v("事件队列\n"),a("ul",[a("li",[t._v("事件驱动型后端")])])]),t._v(" "),a("li",[a("s",[t._v("敏捷开发")]),t._v(" "),a("ul",[a("li",[a("s",[t._v("前端后端一把梭")])])])]),t._v(" "),a("li",[t._v("NPM")])]),t._v(" "),a("p",[t._v("缺点:")]),t._v(" "),a("ul",[a("li",[t._v("不适用于计算密集型应用")]),t._v(" "),a("li",[t._v("动态语言")])]),t._v(" "),a("blockquote",[a("p",[t._v("动态一时爽，重构火葬场\n(TypeScript重构希望"),a("s",[t._v("在做了 在做了")]),t._v(")")])]),t._v(" "),a("ul",[a("li",[t._v("不够完善的后端生态")])]),t._v(" "),a("p",[t._v("本文档使用GitHub作为版本控制工具，访问本文档旧版本内容请前往下列链接查看:\n"),a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP-Online-Judge-doc/blob/master/CUP-Online-Judge%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md",target:"_blank"}},[t._v("CUP-Online-Judge开发文档.md")])]),t._v(" "),a("p",[t._v("阅读本文档需要了解以下预备知识:")]),t._v(" "),a("ul",[a("li",[t._v("Node.js(v"),a("s",[t._v("10.0")]),t._v("12+)")]),t._v(" "),a("li",[t._v("JavaScript(ES"),a("s",[t._v("5")]),a("s",[t._v("6")]),a("s",[t._v("7")]),t._v("10)")]),t._v(" "),a("li",[t._v("TypeScript")]),t._v(" "),a("li",[t._v("PHP(v7.0+)("),a("strong",[t._v("Deprecated")]),t._v("*)")]),t._v(" "),a("li",[t._v("Linux")]),t._v(" "),a("li",[t._v("C++(17+)**")]),t._v(" "),a("li",[t._v("HTML(HTML5 is optional)")]),t._v(" "),a("li",[t._v("Vue.js 2+")]),t._v(" "),a("li",[t._v("CSS3")]),t._v(" "),a("li",[t._v("SQL")]),t._v(" "),a("li",[t._v("Redis")]),t._v(" "),a("li",[t._v("Apache httpd("),a("strong",[t._v("Deprecated")]),t._v(")")]),t._v(" "),a("li",[t._v("Nginx")])]),t._v(" "),a("p",[t._v("*: PHP即将在"),a("code",[t._v("去PHP")]),t._v("计划中被删除。\n**: ThreadPool使用了C++17语法特性(Lambda表达式)")]),t._v(" "),a("h2",{attrs:{id:"程序架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#程序架构"}},[t._v("#")]),t._v(" 程序架构")]),t._v(" "),a("p",[t._v("本程序参照了HUSTOJ与SYZOJ的架构，采用了MySQL + Node.js + Linux C/C++ "),a("s",[t._v("+ PHP")]),t._v("技术栈进行开发。")]),t._v(" "),a("p",[t._v("下列列出的本程序的项目已经开源。")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP-Online-Judge-Express",target:"_blank"}},[t._v("基于Node.js Express开发的后端")])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP-Online-Judge-Judger",target:"_blank"}},[t._v("基于简易沙箱的判题机")])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP-Online-Judge-docker-judger",target:"_blank"}},[t._v("基于Docker的判题机")])]),t._v(" "),a("li",[a("s",[a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP_Online_Judge_Semantic_UI",target:"_blank"}},[t._v("基于Semantic UI构建的、使用Vue.js作为框架的前端")])]),a("a",{attrs:{href:"https://github.com/ryanlee2014/CUP-Online-Judge-NG-FrontEnd",target:"_blank"}},[t._v("基于Vue-Cli 3.0构建的Vue.js单页应用程序")])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/CUP-ACM-Programming-Club/CUP-Online-Judge-Problem-Packer",target:"_blank"}},[t._v("使用Electron Vue开发的跨平台题目打包管理器")])]),t._v(" "),a("li",[a("s",[a("a",{attrs:{href:"https://github.com/ryanlee2014/HUSTOJ-Flat-UI-Theme",target:"_blank"}},[t._v("基于Flat UI开发的PHP事务下的主题")])])])]),t._v(" "),a("p",[t._v("下列部分"),a("s",[t._v("暂未开源，或者")]),t._v("由于即将被替代/与其他开源项目的功能重复决定不做开源处理。")]),t._v(" "),a("ul",[a("li",[t._v("基于Medoo编写的旧版的PHP事务部分")]),t._v(" "),a("li",[t._v("基于Semantic UI与Bootstrap开发的主题")]),t._v(" "),a("li",[t._v("管理员管理后台")])]),t._v(" "),a("p",[t._v("关于本程序采用的开源软件，请访问"),a("a",{attrs:{href:"https://www.cupacm.com/opensource.php",target:"_blank",rel:"noopener noreferrer"}},[t._v("开放源代码声明"),a("OutboundLink")],1),t._v("查看。")]),t._v(" "),a("h2",{attrs:{id:"写在开发前"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写在开发前"}},[t._v("#")]),t._v(" 写在开发前")]),t._v(" "),a("p",[t._v("为了更好的方便内部模块间的协同工作，请认真理解本程序的工作流程，即使它非常的混乱、冗余。")]),t._v(" "),a("p",[t._v("在为本程序进行开发时请时刻"),a("s",[t._v("牢记"),a("strong",[t._v("稳定")]),t._v("与"),a("strong",[t._v("必要")]),t._v("是该程序功能增改的一大原则")]),t._v("考虑以领域驱动设计(DDD)的角度对模组抽象化。")]),t._v(" "),a("p",[t._v("以下是本程序在用户登录后模块间通信的图示。\n"),a("img",{attrs:{src:"https://raw.githubusercontent.com/CUP-ACM-Programming-Club/CUP-Online-Judge-doc/master/pic/program_structure.png",alt:""}})]),t._v(" "),a("p",[t._v("可以分为以下部分。")]),t._v(" "),a("h3",{attrs:{id:"node-js-runtime基于node-js-express开发的后端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js-runtime基于node-js-express开发的后端"}},[t._v("#")]),t._v(" "),a("s",[t._v("Node.js Runtime")]),t._v("基于Node.js Express开发的后端")]),t._v(" "),a("p",[t._v("使用ExpressJS框架，主要功能：")]),t._v(" "),a("ul",[a("li",[t._v("使用Socket.IO与用户进行双向通信")]),t._v(" "),a("li",[t._v("CRUD("),a("strong",[t._v("Deprecated:考虑到Node.js对运算密集部分的不友好，这部分将考虑使用微服务进行拆分")]),t._v(")")]),t._v(" "),a("li",[t._v("维护判题队列")]),t._v(" "),a("li",[t._v("用户权限管理")]),t._v(" "),a("li",[t._v("题目文件部署")]),t._v(" "),a("li",[t._v("WebSocket转发")]),t._v(" "),a("li",[t._v("信息广播")])]),t._v(" "),a("h4",{attrs:{id:"程序文件夹"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#程序文件夹"}},[t._v("#")]),t._v(" 程序文件夹")]),t._v(" "),a("p",[t._v("- root\n--- static 静态文件文件夹(js库/css库)\n--- route 路由文件夹(API接口)\n--- manager 领域设计贫血模型\n--- orm 数据库对象关系映射模型(Sequelize.js)\n--- test 单元测试\n--- bin 启动文件夹(程序启动文件)\n--- module 模块文件夹(被其他文件调用)\n--- middleware 中间件文件夹(中间件)\n--- views 模版文件夹(pug文件模板)\n--- logs 日志文件夹(日志)")]),t._v(" "),a("h4",{attrs:{id:"程序启动-daemon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#程序启动-daemon"}},[t._v("#")]),t._v(" 程序启动(Daemon)")]),t._v(" "),a("p",[a("code",[t._v("npm start")])]),t._v(" "),a("h4",{attrs:{id:"程序启动-debug"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#程序启动-debug"}},[t._v("#")]),t._v(" 程序启动(Debug)")]),t._v(" "),a("p",[a("code",[t._v("npm test")])]),t._v(" "),a("h4",{attrs:{id:"程序重启-daemon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#程序重启-daemon"}},[t._v("#")]),t._v(" 程序重启(Daemon)")]),t._v(" "),a("p",[a("code",[t._v("npm restart")])]),t._v(" "),a("h3",{attrs:{id:"c-judger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#c-judger"}},[t._v("#")]),t._v(" C++ Judger")]),t._v(" "),a("p",[t._v("使用EasyWebsocket、HUSTOJ Judger进行重构、开发\n主要功能:\n判题:")]),t._v(" "),a("h2",{attrs:{id:"一个提交的执行流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一个提交的执行流程"}},[t._v("#")]),t._v(" 一个提交的执行流程")]),t._v(" "),a("h3",{attrs:{id:"客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[t._v("#")]),t._v(" 客户端")]),t._v(" "),a("ol",[a("li",[t._v("用户点击"),a("code",[t._v("提交")]),t._v("按钮")]),t._v(" "),a("li",[t._v("代码、token被打包，委托Socket.IO模块推送到Node.js Runtime")]),t._v(" "),a("li",[t._v("Socket.IO模块接受"),a("code",[t._v("result")]),t._v("事件，调用挂在"),a("code",[t._v("window")]),t._v("上的"),a("code",[t._v("problemsubmitter")]),t._v("Vue实例，Vue实例执行相关操作，显示判题情况。")])]),t._v(" "),a("h3",{attrs:{id:"服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器"}},[t._v("#")]),t._v(" 服务器")]),t._v(" "),a("h5",{attrs:{id:"node-js-runtime"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js-runtime"}},[t._v("#")]),t._v(" Node.js Runtime")]),t._v(" "),a("ol",[a("li",[t._v("(/bin/main.js)收到"),a("code",[t._v("submit")]),t._v("事件响应的数据，将数据移交"),a("code",[t._v("submitControl")]),t._v("模块，判断提交合法性并解包数据，存储至数据库中")]),t._v(" "),a("li",[t._v("等待模块返回完成信号，建立socket连接与solution_id的映射，将判题任务移交到判题机")]),t._v(" "),a("li",[t._v("判题机维护判题队列。\n"),a("ul",[a("li",[t._v("若队列空闲则直接唤起空闲判题机移交判题任务")]),t._v(" "),a("li",[t._v("若队列非空，则赋予高优先权移交队列，等待判题机结束后询问队列，入队判题")])])]),t._v(" "),a("li",[t._v("通过WebSocket模块接收来自判题机的判题信息，通过查阅solution_id对应的socket连接，将数据转发给对应socket")]),t._v(" "),a("li",[t._v("WebSocket模块通过检测完成信号，释放相关资源")]),t._v(" "),a("li",[t._v("判题机判题结束，检查队列任务，若队列非空，则获取队列头的任务进行判题，若队列为空，则判题机入空闲队列")])]),t._v(" "),a("h4",{attrs:{id:"c-judger-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#c-judger-2"}},[t._v("#")]),t._v(" C++ Judger")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("被Node.js Runtime唤醒，建立简易沙箱环境，"),a("s",[t._v("获取MySQL连接")]),t._v("目前开启"),a("code",[t._v("-no-mysql")]),t._v("模式，会变为使用Node.js通过WebSocket传送数据至后端")])]),t._v(" "),a("li",[a("p",[t._v("初始化系统调用，载入数据文件")])]),t._v(" "),a("li",[a("p",[t._v("判断提交类型")]),t._v(" "),a("ul",[a("li",[t._v("测试运行：不进行答案比对，直接返回评测数据，程序结束")]),t._v(" "),a("li",[t._v("正常提交：根据题目内容进行评测，根据数据库取出的数据决定判题方法为"),a("code",[t._v("文本对比")]),t._v("或"),a("code",[t._v("Special Judge")]),t._v(" "),a("ul",[a("li",[t._v("文本对比：对比标准输出与用户输出的内容，返回"),a("code",[t._v("Wrong Answer")]),t._v("/"),a("code",[t._v("Presentation Error")]),t._v("/"),a("code",[t._v("Accept")]),t._v("信息")]),t._v(" "),a("li",[t._v("Special Judge: 将输入文件、输出文件、用户输出、用户代码传入程序，根据程序退出时返回的值决定判题结果。理论上可以返回所有的判题结果。")])])])])]),t._v(" "),a("li",[a("p",[t._v("数据保存，更新用户数据与题目数据")])]),t._v(" "),a("li",[a("p",[t._v("退出程序")])])]),t._v(" "),a("h2",{attrs:{id:"php与node-js之间如何共享用户数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#php与node-js之间如何共享用户数据"}},[t._v("#")]),t._v(" PHP与Node.js之间如何共享用户数据")]),t._v(" "),a("p",[t._v("在每次访问PHP页面时，"),a("code",[t._v("/include/db_info.inc.php")]),t._v("文件作为所有PHP文件的头文件被引入到PHP文件中，该文件包括了数据库相关的函数初始化以及缓存数据库的初始化。同时该文件会生成一个和用户"),a("code",[t._v("user_id")]),t._v("相关的"),a("code",[t._v("token")]),t._v(",并将"),a("code",[t._v("token")]),t._v("和"),a("code",[t._v("user_id")]),t._v("一同保存在cookie中，在页面进行XHR时cookie会一同发送到Node.js运行时环境")]),t._v(" "),a("p",[t._v("若访问的是Vue单页应用(即当前生效的页面),"),a("code",[t._v("generate_token")]),t._v("中间件会在"),a("code",[t._v("cookie")]),t._v("中添加一个"),a("code",[t._v("newToken")]),t._v("及"),a("code",[t._v("user_id")]),t._v("字段，并通过Redis为List: ${user_id}newToken添加一个新的token,PHP页面通过"),a("code",[t._v("/include/db_info.inc.php")]),t._v("进行登录鉴权。")]),t._v(" "),a("h2",{attrs:{id:"configmanager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configmanager"}},[t._v("#")]),t._v(" ConfigManager")]),t._v(" "),a("p",[t._v("ConfigManager是一个系统参数及开关状态的统一管理模块，通过设置存储模块和日志模块进行可持久化及日志回滚操作。")]),t._v(" "),a("p",[t._v("模块支持使用"),a("strong",[t._v("MySQL")]),t._v("及"),a("strong",[t._v("Redis")]),t._v("进行持久化。")]),t._v(" "),a("p",[t._v("该模块目前在后端用于灰度发布及动态配置管理。")]),t._v(" "),a("h3",{attrs:{id:"config"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#config"}},[t._v("#")]),t._v(" Config")]),t._v(" "),a("p",[t._v("Config是一个运行时根据管理员设置动态改变的key-value配置。开发者可以在任何需要动态配置的地方插入"),a("code",[t._v("ConfigManager.getConfig(key)")]),t._v("获得Config数据。需要注意的是"),a("code",[t._v("key")]),t._v("值是唯一的，"),a("code",[t._v("Config")]),t._v("表不能有重复key值存在。")]),t._v(" "),a("h3",{attrs:{id:"switch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#switch"}},[t._v("#")]),t._v(" Switch")]),t._v(" "),a("p",[t._v("Switch是一个运行时根据管理员设置的动态改变的开关。开关的值为"),a("span",{staticClass:"katex"},[a("span",{staticClass:"katex-mathml"},[a("math",[a("semantics",[a("mrow",[a("mo",{attrs:{stretchy:"false"}},[t._v("[")]),a("mn",[t._v("0")]),a("mo",{attrs:{separator:"true"}},[t._v(",")]),a("mn",[t._v("100")]),a("mo",{attrs:{stretchy:"false"}},[t._v("]")])],1),a("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("[0,100]")])],1)],1)],1),a("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[a("span",{staticClass:"base"},[a("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),a("span",{staticClass:"mopen"},[t._v("[")]),a("span",{staticClass:"mord"},[t._v("0")]),a("span",{staticClass:"mpunct"},[t._v(",")]),a("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),a("span",{staticClass:"mord"},[t._v("1")]),a("span",{staticClass:"mord"},[t._v("0")]),a("span",{staticClass:"mord"},[t._v("0")]),a("span",{staticClass:"mclose"},[t._v("]")])])])]),t._v(",其中开关值代表开关打开的概率。不难发现，0代表开关关闭，100代表开关打开，而中间态代表开关有一定概率是打开状态，而概率为"),a("span",{staticClass:"katex"},[a("span",{staticClass:"katex-mathml"},[a("math",[a("semantics",[a("mrow",[a("mi",[t._v("n")])],1),a("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("n")])],1)],1)],1),a("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[a("span",{staticClass:"base"},[a("span",{staticClass:"strut",staticStyle:{height:"0.43056em","vertical-align":"0em"}}),a("span",{staticClass:"mord mathdefault"},[t._v("n")])])])]),t._v("%。在每次调用"),a("code",[t._v("ConfigManager.isSwitchedOn(key)")]),t._v("的时候，系统会随机生成一个"),a("span",{staticClass:"katex"},[a("span",{staticClass:"katex-mathml"},[a("math",[a("semantics",[a("mrow",[a("mo",{attrs:{stretchy:"false"}},[t._v("[")]),a("mn",[t._v("0")]),a("mo",{attrs:{separator:"true"}},[t._v(",")]),a("mn",[t._v("100")]),a("mo",{attrs:{stretchy:"false"}},[t._v("]")])],1),a("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("[0,100]")])],1)],1)],1),a("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[a("span",{staticClass:"base"},[a("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),a("span",{staticClass:"mopen"},[t._v("[")]),a("span",{staticClass:"mord"},[t._v("0")]),a("span",{staticClass:"mpunct"},[t._v(",")]),a("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),a("span",{staticClass:"mord"},[t._v("1")]),a("span",{staticClass:"mord"},[t._v("0")]),a("span",{staticClass:"mord"},[t._v("0")]),a("span",{staticClass:"mclose"},[t._v("]")])])])]),t._v("的数与设置的数进行大小对比以获得开关状态。\n显然，Switch是一种特殊的Config。")]),t._v(" "),a("p",[a("strong",[t._v("ConfigManager在系统中是一个单例模块")])]),t._v(" "),a("h2",{attrs:{id:"node-js-router开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js-router开发"}},[t._v("#")]),t._v(" Node.js Router开发")]),t._v(" "),a("p",[t._v("要使前端能够调用接口，访问数据，就需要开发对应的Router响应时间。所有的Router文件均放置于文件夹"),a("code",[t._v("/router")]),t._v("下。编写Router的方式与Express.js官网的模板相似，只需导出数组")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"router_path"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" middleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("就能够被app.js自动在启动时载入。")]),t._v(" "),a("h3",{attrs:{id:"interceptor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#interceptor"}},[t._v("#")]),t._v(" Interceptor")]),t._v(" "),a("p",[t._v("对于部分需要根据后台配置管理的路由，可以在暴露的数组中添加"),a("code",[t._v("Interceptor")]),t._v("中间件，从"),a("code",[t._v("/module/interceptor/middleware.js")]),t._v("中通过"),a("code",[t._v("InterceptorFactory")]),t._v("配置"),a("code",[t._v("validator")]),t._v(",使用"),a("code",[t._v("getInterceptorInstance")]),t._v("获得拦截器实例放入路由出参middleware中即可。")]),t._v(" "),a("p",[a("code",[t._v("validator")]),t._v(": boolean Function(req, res), 传入"),a("code",[t._v("request")]),t._v("，"),a("code",[t._v("response")]),t._v("对象，根据返回值决定是否调用"),a("code",[t._v("next()")]),t._v("执行下一个中间件。")]),t._v(" "),a("p",[t._v("可以配合"),a("code",[t._v("ConfigManager")]),t._v("中的"),a("code",[t._v("switch")]),t._v("及"),a("code",[t._v("config")]),t._v("进行动态更改开闭状态。")]),t._v(" "),a("h2",{attrs:{id:"node-js-module开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js-module开发"}},[t._v("#")]),t._v(" Node.js Module开发")]),t._v(" "),a("p",[t._v("所有的后台功能若是能够抽象的，应该开发成"),a("code",[t._v("Module")]),t._v("以供使用。开发的Module存放在"),a("code",[t._v("/module")]),t._v("文件夹下即可")]),t._v(" "),a("h2",{attrs:{id:"node-js-socket-io开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js-socket-io开发"}},[t._v("#")]),t._v(" Node.js Socket.IO开发")]),t._v(" "),a("p",[t._v("该模块是后台程序诞生的原因"),a("s",[t._v("显示在线人数")]),t._v(",因此这里的代码是所有代码中历史最久远的部分。目前还没有整理方便置入中间件或绑定响应时间的接口。请等待版本更新。")]),t._v(" "),a("h2",{attrs:{id:"前端开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端开发"}},[t._v("#")]),t._v(" 前端开发")]),t._v(" "),a("p",[t._v("前端是本系统中一个非常重要的部分。考虑到服务器本身对CPU的依赖，于是所有的非保密数据的运算均由客户端(即用户浏览器)运算得出。")]),t._v(" "),a("p",[t._v("本平台界面采用Semantic UI进行构建，因此能够支持"),a("s",[t._v("Semantic UI")]),t._v("Fomantic UI最新文档下的所有模块及特效。")]),t._v(" "),a("p",[t._v("大多数的页面由最新版本的Vue.js驱动。由于"),a("code",[t._v("去PHP计划")]),t._v("还没有全面完成，部分页面仍将使用旧版的PHP模块驱动。\n目前还使用PHP模块驱动的页面有(此处不考虑CUP Virtual Judge):")]),t._v(" "),a("ul",[a("li",[a("s",[t._v("竞赛及作业")])]),t._v(" "),a("li",[a("s",[t._v("管理员后台")])]),t._v(" "),a("li",[a("s",[t._v("编译错误页面")])]),t._v(" "),a("li",[a("s",[t._v("运行错误页面")])]),t._v(" "),a("li",[t._v("注册页面*")])]),t._v(" "),a("p",[t._v("删除在"),a("code",[t._v("3.0.0-alpha")]),t._v("版本中已重构的部分\n*: 正在重构中")]),t._v(" "),a("p",[t._v("以上的页面将在不久的将来被Vue页面替代，因此在这些页面上进行功能增删需要三思。")]),t._v(" "),a("p",[t._v("当前所有的前端请求均通过"),a("strong",[t._v("AJAX")]),t._v("与后端保持通信，"),a("s",[t._v("考虑到Semantic UI仍然基于jQuery进行开发，为了减少过多第三方库的引入，建议直接使用jQuery的接口进行XHR请求")]),t._v("请直接在"),a("code",[t._v("CUP-Online-Judge-NG-Frontend")]),t._v("中使用"),a("code",[t._v("this.axios")]),t._v("进行AJAX操作。")]),t._v(" "),a("p",[t._v("有少数的功能不能够使用AJAX通信，而必须使用Socket.IO接口与后端通信。")]),t._v(" "),a("ul",[a("li",[t._v("历史页面最新提交的更新")]),t._v(" "),a("li",[t._v("题目提交页面评测题目")]),t._v(" "),a("li",[t._v("黑板")]),t._v(" "),a("li",[t._v("全局信息推送")]),t._v(" "),a("li",[t._v("建立WebSocket时提交的环境数据")]),t._v(" "),a("li",[t._v("在线用户情况")]),t._v(" "),a("li",[t._v("评测队列")])]),t._v(" "),a("h2",{attrs:{id:"git"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#git"}},[t._v("#")]),t._v(" Git")]),t._v(" "),a("h3",{attrs:{id:"版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#版本"}},[t._v("#")]),t._v(" 版本")]),t._v(" "),a("p",[t._v("开发版本格式为："),a("code",[t._v("${major-version}.${maintain-version}.${bugfix-version/refactor-version/hotfix-version}[optional: ${alpha|beta|ppe}]")])]),t._v(" "),a("h4",{attrs:{id:"如何针对代码的改变选择适合的版本号变化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何针对代码的改变选择适合的版本号变化"}},[t._v("#")]),t._v(" 如何针对代码的改变选择适合的版本号变化")]),t._v(" "),a("p",[t._v("当出现以下变化的，大版本增加:")]),t._v(" "),a("ul",[a("li",[t._v("核心代码完全重构")]),t._v(" "),a("li",[t._v("环境更改")])]),t._v(" "),a("p",[t._v("当出现以下变化的，小版本增加:")]),t._v(" "),a("ul",[a("li",[t._v("增加前/后端模块链")]),t._v(" "),a("li",[t._v("修改前/后端模块链")]),t._v(" "),a("li",[t._v("新增/修改Plugin")]),t._v(" "),a("li",[t._v("新增非重要功能")]),t._v(" "),a("li",[t._v("删除模块/UI更改")])]),t._v(" "),a("p",[t._v("当出现以下变化时，修复版本增加:")]),t._v(" "),a("ul",[a("li",[t._v("修复Bugs")]),t._v(" "),a("li",[t._v("更新依赖")]),t._v(" "),a("li",[t._v("更正typo")]),t._v(" "),a("li",[t._v("新增/修改测试用例")]),t._v(" "),a("li",[t._v("无感知的功能重构")])]),t._v(" "),a("h2",{attrs:{id:"发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#发布"}},[t._v("#")]),t._v(" 发布")]),t._v(" "),a("p",[a("strong",[t._v("非线上紧急修复问题，一律禁止在高峰期进行任何发布")])]),t._v(" "),a("h3",{attrs:{id:"后端发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#后端发布"}},[t._v("#")]),t._v(" 后端发布")]),t._v(" "),a("h4",{attrs:{id:"websocket发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#websocket发布"}},[t._v("#")]),t._v(" WebSocket发布")]),t._v(" "),a("p",[t._v("该服务为单例应用，重启过程没有任何安全措施。请尽可能于低峰期发布。\n未来将考虑接入主Cluster节点。")]),t._v(" "),a("h4",{attrs:{id:"功能发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#功能发布"}},[t._v("#")]),t._v(" 功能发布")]),t._v(" "),a("p",[t._v("该服务涉及除判题机及在线用户以外的所有服务，目前可采用安全的在线热部署进行重启。")]),t._v(" "),a("p",[t._v("热部署触发链接:"),a("RouterLink",{attrs:{to:"/api/admin/system/hot-reload/"}},[t._v("Hot-Reload")])],1),t._v(" "),a("p",[t._v("管理员通过以下链接Notify主进程进行重启作业。重启失败时，现有Worker将不会被替代。")]),t._v(" "),a("p",[t._v("同理，主进程相关逻辑为单例应用，重启过程有一定的安全措施，但也请务必在低峰期更改。")]),t._v(" "),a("p",[t._v("Master重启流程")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_300893f6",graph:t.$dataBlock.mermaid_300893f6}})],1)}),[],!1,null,null,null);"function"==typeof n&&n(r);s.default=r.exports}}]);